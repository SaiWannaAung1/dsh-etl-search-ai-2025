version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # 1. Vector Database (Qdrant)
  # ---------------------------------------------------------------------------
  qdrant:
    image: qdrant/qdrant:latest
    container_name: dsh-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - ./data/qdrant_storage:/qdrant/storage:z
    restart: unless-stopped


  # ---------------------------------------------------------------------------
  # 2. Backend API (ASP.NET Core)
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: dsh-backend
    ports:
      - "5000:8080" # Maps localhost:5000 to container:8080
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Data Source=/app/data/dsh-metadata.db
      - VectorStore__Host=qdrant
      - VectorStore__Port=6333
    volumes:
      - ./data/sqlite:/app/data:z   # Persist SQLite DB
      - ./data/temp:/app/temp:z     # Temporary download folder
    depends_on:
      - qdrant
    deploy:
      resources:
        limits:
          memory: 8G
    restart: on-failure


  # ---------------------------------------------------------------------------
  # 3. Frontend (Svelte - Placeholder)
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: dsh-frontend
    ports:
      - "5173:3000" # Maps your browser at :5173 to Node at :3000
    environment:
      - NODE_ENV=production
      # This is for Server-Side Rendering (Internal Docker Network)
      - API_INTERNAL_URL=http://backend:8080
      # This is for Client-Side (Your Browser)
      - PUBLIC_API_URL=http://localhost:5000/api
    depends_on:
      - backend
    restart: unless-stopped
  
networks:
  default:
    name: dsh-network