Based on the system constraints and the need for optimization, I have classified the Data Flow Diagram into two distinct subsystems: The Ingestion Pipeline (Write-Heavy) and The Discovery Pipeline (Read-Heavy).

This classification allows us to apply different optimization strategies to each flow (e.g., streaming for ingestion, caching for discovery).

1. The Ingestion Pipeline (ETL Subsystem)
   Classification: Asynchronous, Batch/Background Process. Optimization: Streaming I/O (to handle large ZIPs) and Hashing (to avoid re-embedding unchanged text). Data Source: CEH Catalogue (WAF/Sitemap). Output: SQLite Database & Vector Store.
```aiignore
(Start ETL Job)
                                         |
                                         v
+-----------------------+      +---------------------------+
|   CEH Catalogue WAF   |----->|   Change Detection Svc    |
|   (External Source)   |      |  (Check ETag / Headers)   |
+-----------------------+      +-------------+-------------+
                                             |
                               (If New/Modified Resource)
                                             |
                                             v
                               +---------------------------+
                               |     Stream Downloader     |
                               | (No full load into RAM)   |
                               +-------------+-------------+
                                             |
                                  (Stream File Buffers)
                                             |
                                             v
                       +-------------------------------------------+
                       |           Extraction Strategy             |
                       |  (Factory: XML vs JSON vs ZIP Handler)    |
                       +---------------------+---------------------+
                                             |
                      +----------------------+----------------------+
                      |                                             |
                      v                                             v
          +-----------------------+                   +-----------------------+
          |    Metadata Parser    |                   |   Document Chunker    |
          |  (Extract Titles/Abs) |                   | (Split PDFs/Docs for  |
          |                       |                   |      RAG context)     |
          +-----------+-----------+                   +-----------+-----------+
                      |                                           |
                      | (Structured Info)           (Text Chunks) |
                      v                                           v
          +-----------------------+                   +-----------------------+
          |    SQLite Database    |                   |   Embedding Hash Map  |
          | (Relational Metadata) |                   |     (Cache Check)     |
          +-----------------------+                   +-----------+-----------+
                                                                  |
                                                     (If Hash Miss: Compute)
                                                                  |
                                                                  v
                                                      +-----------------------+
                                                      |   Embedding Model     |
                                                      | (Local LLM / ONNX)    |
                                                      +-----------+-----------+
                                                                  |
                                                            (Vector Floats)
                                                                  |
                                                                  v
                                                      +-----------------------+
                                                      |      Vector Store     |
                                                      | (Semantic Indexing)   |
                                                      +-----------------------+
```


2. The Discovery Pipeline (Search & RAG)
   Classification: Synchronous, Real-time User Interaction. Optimization: Output Caching (for frequent queries) and localized vector search. Data Source: Svelte Web App. Output: JSON Search Results / Conversational Answer.

```aiignore
+------------------------+
      |    User / Svelte UI    |
      |   (Search / Chat)      |
      +-----------+------------+
                  |
                  | (1) JSON Request (Query)
                  v
      +------------------------+
      |   ASP.NET Middleware   |
      |    (Response Cache)    |<---(Hit?)---[ Return Cached Result ]
      +-----------+------------+
                  |
         (Miss: Proceed)
                  |
                  v
      +------------------------+
      |   Search Orchestrator  |
      +-----------+------------+
                  |
      +-----------+-----------------------------------------+
      |                                                     |
      | (2) Embed Query                                     | (3) Keyword Filter
      v                                                     v
+---------------------+                           +---------------------+
|   Embedding Model   |                           |   SQLite Database   |
|   (Query -> Vector) |                           |  (Filters: Date,    |
+----------+----------+                           |   File Type, etc.)  |
           |                                      +----------+----------+
           | (Vector)                                        |
           v                                                 |
+---------------------+                                      |
|    Vector Store     |                                      |
| (Nearest Neighbor)  |<-------------------------------------+
+----------+----------+           (Filter IDs)
           |
           | (4) Return Top-K Document IDs
           v
+---------------------+
|   Result Aggregator |
| (Join Vector IDs    |
|  with SQLite Data)  |
+----------+----------+
           |
           | (5) Context + Original Query
           v
+---------------------+
|      LLM Agent      | (Optional/Bonus for RAG)
|   (Conversational)  | [cite: 124]
+----------+----------+
           |
           | (6) Final Response
           v
      +------------------------+
      |    User / Svelte UI    |
      +------------------------+
```


