
Based on the refined Clean Architecture and CQRS-style split (Ingestion vs. Discovery) we designed, here is the complete C# ASP.NET Core solution structure.

This structure enforces the "Dependency Rule": Dependencies only flow inwards. The Core depends on nothing; Infrastructure and API depend on Core.

Solution: DshEtlSearch.sln

The solution is divided into three physical projects (plus tests) to strictly enforce architectural boundaries.


#### 1. Layer B: Application Core (DshEtlSearch.Core)
Type: .NET Class Library Dependencies: None Purpose: Holds the Business Logic, Interfaces, and Domain Entities. It defines "What" the system does.

```aiignore
DshEtlSearch.Core/
├── Common/
│   ├── Enums/
│   │   └── FileType.cs              (XML, JSON, PDF)
│   └── Result.cs                    (Wrapper for Success/Failure returns)
│
├── Domain/                          [The pure Data Entities]
│   ├── Dataset.cs                   (Root Aggregate)
│   ├── MetadataRecord.cs            (Extracted metadata fields)
│   ├── SupportingDocument.cs        (Linked files)
│   └── EmbeddingVector.cs           (Vector data representation)
│
├── Interfaces/                      [The Ports / Contracts]
│   ├── Infrastructure/
│   │   ├── IDatasetDownloader.cs    (Contract for fetching WAF/Zips)
│   │   ├── IArchiveProcessor.cs     (Contract for unzipping)
│   │   ├── IMetadataParser.cs       (Contract for XML/JSON parsing Strategy)
│   │   ├── IMetadataRepository.cs   (Contract for SQLite)
│   │   ├── IVectorStore.cs          (Contract for Vector DB)
│   │   └── ILlmClient.cs            (Contract for AI/LLM)
│   │
│   └── Services/
│       ├── IEtlService.cs
│       └── ISearchService.cs
│
└── Features/                        [The Use Cases - CQRS Split]
    ├── Ingestion/                   (The "Write" Side)
    │   ├── EtlOrchestrator.cs       (Main workflow: Download -> Parse -> Save)
    │   └── DatasetProcessor.cs      (Logic for handling stream buffers)
    │
    └── Discovery/                   (The "Read" Side)
        ├── SearchService.cs         (Orchestrates vector + keyword search)
        ├── RagService.cs            (Constructs prompts for Chat)
        └── Models/
            └── SearchResultDto.cs   (Internal transfer object)
```

#### 2. Layer C: Infrastructure (DshEtlSearch.Infrastructure)
Type: .NET Class Library Dependencies: DshEtlSearch.Core, EntityFrameworkCore, System.IO.Compression Purpose: Implements the interfaces defined in Core. It defines "How" the system does it.

```aiignore
DshEtlSearch.Infrastructure/
├── Data/                            [Persistence Adapters]
│   ├── SQLite/
│   │   ├── AppDbContext.cs          (EF Core Context)
│   │   ├── Migrations/
│   │   └── SqliteMetadataRepository.cs  (Impl of IMetadataRepository)
│   │
│   └── VectorStore/
│       ├── QdrantAdapter.cs         (Impl of IVectorStore using Qdrant)
│       └── LocalVectorStore.cs      (Alternative: Impl using local file)
│
├── ExternalServices/                [Network Gateways]
│   ├── Ceh/
│   │   └── CehDatasetDownloader.cs  (Impl of IDatasetDownloader - HTTP Client)
│   └── Ai/
│       └── OpenAiLlmClient.cs       (Impl of ILlmClient - Calls OpenAI/Ollama)
│
└── FileProcessing/                  [File Handling Logic]
    ├── Archives/
    │   └── ZipExtractionService.cs  (Impl of IArchiveProcessor - System.IO.Compression)
    │
    └── Parsers/                     [Strategy Pattern Implementation]
        ├── MetadataParserFactory.cs (Factory: Returns correct parser)
        └── Strategies/
            ├── Iso19115XmlParser.cs (Impl of IMetadataParser for XML)
            ├── JsonLdParser.cs      (Impl of IMetadataParser for JSON)
            └── RdfTurtleParser.cs   (Impl of IMetadataParser for RDF)


```

#### 3. Layer A: Presentation (DshEtlSearch.Api)
Type: ASP.NET Core Web API Dependencies: DshEtlSearch.Core, DshEtlSearch.Infrastructure Purpose: The entry point. Handles HTTP requests and maps them to Core services.

```aiignore
DshEtlSearch.Api/
├── Controllers/
│   ├── SearchController.cs          (GET /api/search)
│   ├── ChatController.cs            (POST /api/chat - Calls RagService)
│   └── AdminEtlController.cs        (POST /api/etl/trigger - Calls EtlOrchestrator)
│
├── Middleware/
│   ├── ExceptionHandlingMiddleware.cs
│   └── ResponseCachingMiddleware.cs (Custom cache logic for search results)
│
├── Models/                          [API DTOs]
│   ├── Requests/
│   │   ├── SearchRequest.cs
│   │   └── ChatRequest.cs
│   └── Responses/
│       ├── DatasetResponse.cs
│       └── ChatResponse.cs
│
├── Configuration/
│   ├── ServiceCollectionExtensions.cs (DI Registration for Core/Infra)
│   └── AppSettings.cs               (Strongly typed config)
│
├── appsettings.json                 (Config: DB Strings, API Keys)
└── Program.cs                       (Entry point, DI wiring)

```

#### 4. Tests (DshEtlSearch.Tests)

Type: XUnit Project Purpose: Ensures reliability and evolution safety.

```aiignore
DshEtlSearch.Tests/
├── Core/
│   ├── EtlOrchestratorTests.cs      (Mocking IDatasetDownloader to test logic)
│   └── RagServiceTests.cs           (Mocking IVectorStore to test prompts)
│
└── Infrastructure/
    ├── Parsers/
    │   └── IsoXmlParserTests.cs     (Testing with sample .xml files)
    └── Archives/
        └── ZipExtractionTests.cs    (Testing stream handling)

```
